<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Envio de PDFs (Administrador)</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f6f8fb; color:#1c2635;}
    .wrap{max-width:900px; margin:32px auto; padding:0 16px;}
    .card{background:#fff; border-radius:20px; box-shadow:0 10px 24px rgba(2,18,33,.06); padding:28px;}
    h1{margin:0 0 8px; font-size:32px}
    .hint{color:#5b6b7b; font-size:14px}
    .row{margin-top:18px}
    input[type="password"], input[type="text"]{width:100%; height:48px; border-radius:12px; border:1px solid #d8e0ea; padding:0 12px; font-size:16px; outline:none}
    input[type="file"]{width:100%}
    .btn{display:inline-flex; align-items:center; gap:10px; border:none; border-radius:14px; background:#0e3a5b; color:#fff; padding:14px 20px; font-weight:600; cursor:pointer}
    .btn.secondary{background:#153e66}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .pill{display:inline-block; background:#eef4ff; color:#0e3a5b; border-radius:999px; padding:4px 10px; font-size:12px}
    .status{margin-top:14px; white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#f4f7fb; border:1px solid #e7edf5; padding:10px 12px; border-radius:10px}
    .list{margin-top:18px; display:flex; flex-direction:column; gap:10px}
    .item{display:flex; align-items:center; justify-content:space-between; gap:10px; background:#f8fbff; border:1px solid #e7edf5; padding:12px; border-radius:12px}
    .name{overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .danger{background:#b42318}
    .toolbar{display:flex; gap:12px; flex-wrap:wrap}
    .topnav{display:flex; gap:12px; margin-bottom:16px}
    .link{background:#e9f1ff; color:#143b63; padding:10px 14px; border-radius:12px; text-decoration:none; font-weight:600}
    .muted{color:#6a7a8b}
    .spinner{width:16px;height:16px;border:3px solid #c7d6ea;border-top-color:#0e3a5b;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topnav">
      <a class="link" href="/admin">Upload</a>
      <a class="link" id="btnList">Ver PDFs</a>
      <a class="link" href="/">Chat</a>
    </div>

    <div class="card">
      <h1>Envio de PDFs <span class="pill">(Administrador)</span></h1>
      <p class="hint">Insira a senha do administrador (<code>ADMIN_UPLOAD_TOKEN</code>) e envie seus arquivos. PDFs muito grandes podem falhar em PaaS. Prefira &lt; <b>80‚Äì100&nbsp;MB</b>.</p>

      <div class="row">
        <label class="muted">Senha do administrador</label>
        <input type="password" id="admPwd" placeholder="ADMIN_UPLOAD_TOKEN" />
      </div>

      <div class="row">
        <label class="muted">Selecionar PDF</label>
        <input type="file" id="file" accept="application/pdf" />
      </div>

      <div class="row toolbar">
        <button class="btn" id="btnUpload">üì¶ Enviar PDFs</button>
        <button class="btn secondary" id="btnRefresh">üìÑ Ver PDFs Enviados</button>
      </div>

      <div id="msg" class="status" style="display:none"></div>

      <h3 style="margin-top:26px">Arquivos no servidor</h3>
      <div id="list" class="list"></div>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const msg = $("#msg");
const list = $("#list");
const btnUpload = $("#btnUpload");
const btnRefresh = $("#btnRefresh");
const btnList = $("#btnList");

function show(text, isError=false){
  msg.style.display = "block";
  msg.style.borderColor = isError ? "#ffd5d5" : "#e7edf5";
  msg.style.background = isError ? "#fff5f5" : "#f4f7fb";
  msg.textContent = text;
}

function token(){
  const t = $("#admPwd").value.trim();
  if(!t){ alert("Preencha a senha do administrador."); }
  return t;
}

async function fetchJSON(url, opt={}){
  const t = token(); if(!t) throw new Error("Sem token");
  opt.headers = Object.assign({}, opt.headers || {}, { "x-admin-token": t });
  const res = await fetch(url, opt);
  const ctype = res.headers.get("content-type") || "";
  if(!res.ok){
    const body = ctype.includes("application/json") ? await res.json() : await res.text();
    const detail = typeof body === "string" ? body : (body.detail || JSON.stringify(body));
    throw new Error(detail);
  }
  return ctype.includes("application/json") ? res.json() : res.text();
}

async function upload(){
  try{
    const f = $("#file").files[0];
    if(!f){ alert("Selecione um PDF."); return; }
    if(!f.name.toLowerCase().endsWith(".pdf")){
      alert("Envie apenas .pdf"); return;
    }
    btnUpload.disabled = true;
    show("‚¨ÜÔ∏è Enviando arquivo‚Ä¶ aguarde (n√£o feche a p√°gina).");

    const fd = new FormData(); fd.append("file", f);
    const res = await fetchJSON("/upload_pdf", { method:"POST", body: fd });

    if(res.ok){
      show("‚úÖ Upload recebido: " + res.filename + "\nüîÑ Indexa√ß√£o em progresso‚Ä¶ aguarde ~10 segundos antes de perguntar no chat.");
      listPDFs(); // atualiza a lista
    }else{
      show("‚ö†Ô∏è Upload salvo mas indexa√ß√£o falhou: " + (res.index_error || "erro"), true);
    }
  }catch(err){
    // Quando o Render devolve HTML 502, o corpo come√ßa com '<'
    const text = String(err.message || err);
    if(text.trim().startsWith("<")){
      show("‚ùå Erro inesperado do servidor (502). Tente novamente com um PDF menor (<80‚Äì100MB).", true);
    }else{
      show("‚ùå " + text, true);
    }
  }finally{
    btnUpload.disabled = false;
  }
}

async function listPDFs(){
  try{
    list.innerHTML = `<div class="muted"><span class="spinner"></span> Carregando lista‚Ä¶</div>`;
    const res = await fetchJSON("/list_pdfs");
    if(!res.files || !res.files.length){
      list.innerHTML = `<div class="muted">Nenhum PDF enviado.</div>`;
      return;
    }
    list.innerHTML = "";
    res.files.forEach(name=>{
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="name" title="${name}">üìÑ ${name}</div>
        <div class="toolbar">
          <button class="btn danger" data-name="${name}">Excluir</button>
        </div>`;
      row.querySelector(".danger").onclick = ()=>del(name);
      list.appendChild(row);
    });
  }catch(err){
    list.innerHTML = `<div class="muted">Falha ao listar: ${err}</div>`;
  }
}

async function del(name){
  if(!confirm(`Excluir "${name}"?`)) return;
  try{
    await fetchJSON(`/delete_pdf?name=${encodeURIComponent(name)}`, { method:"DELETE" });
    show("üóëÔ∏è Arquivo exclu√≠do: " + name);
    listPDFs();
  }catch(err){
    show("‚ùå Falha ao excluir: " + err, true);
  }
}

btnUpload.onclick = upload;
btnRefresh.onclick = listPDFs;
btnList.onclick = listPDFs;

// carrega a lista quando abrir
listPDFs();
</script>
</body>
</html>
