<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Envio de PDFs ‚Äî Licitabot (Admin)</title>
  <style>
    :root{
      --bg:#f5f7fa; --card:#ffffff; --ink:#0b2942; --muted:#475569;
      --btn:#0b3d5c; --ok:#166534; --err:#991b1b; --chip:#eef2f7;
      --shadow:0 12px 32px rgba(0,0,0,.12);
    }
    html,body{height:100%;margin:0}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color:#1f2937; display:flex; align-items:center;
      justify-content:center; padding:28px;
    }
    .wrap{width:100%; max-width:820px;}
    .toolbar{display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:18px}
    .tool{
      background:#eaf1f7; border:1px solid #d7e2ee; color:#0b2942;
      border-radius:16px; padding:16px; display:flex; align-items:center; gap:10px;
      font-weight:700; cursor:pointer; user-select:none; transition:transform .05s ease-in;
      justify-content:center;
    }
    .tool:hover{transform:translateY(-1px)}
    .tool span{font-size:15px}
    .card{
      background:var(--card); border-radius:20px; box-shadow:var(--shadow);
      padding:26px;
    }
    h1{margin:0 0 6px; color:var(--ink); font-size:28px}
    .sub{margin:0 0 18px; color:var(--muted)}
    .row{display:flex; gap:12px; margin-bottom:12px}
    input[type=password], input[type=text]{
      flex:1; padding:12px 14px; border:1px solid #cbd5e1; border-radius:12px; font-size:16px;
    }
    input[type=file]{flex:1; padding:10px; border:1px dashed #cbd5e1; border-radius:12px; background:#fff}
    button.primary{
      background:var(--btn); color:#fff; border:none; padding:12px 22px; border-radius:12px;
      font-weight:800; cursor:pointer;
    }
    .status{margin-top:14px; font-size:14px; max-height:280px; overflow:auto}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .chip{display:inline-block; background:var(--chip); border:1px solid #dbe3ee; padding:4px 8px;
      border-radius:999px; margin:4px 6px 0 0; font-size:12px}
    .divider{height:1px; background:#e6eef6; margin:16px 0}
    .muted{color:#64748b; font-size:13px; margin-top:8px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Barra de atalhos -->
    <div class="toolbar">
      <div class="tool" id="btnUpload">
        <div style="font-size:20px">üì¶</div> <span>Upload</span>
      </div>
      <div class="tool" id="btnListar">
        <div style="font-size:20px">üìÇ</div> <span>Ver PDFs</span>
      </div>
      <div class="tool" id="btnChat">
        <div style="font-size:20px">üí¨</div> <span>Chat</span>
      </div>
    </div>

    <!-- Cart√£o principal -->
    <div class="card" id="cardUpload">
      <h1>Envio de PDFs (Admin)</h1>
      <p class="sub">Digite a senha do administrador e selecione um ou mais PDFs.</p>

      <div class="row">
        <input id="senha" type="password" placeholder="Senha do admin (ADMIN_UPLOAD_TOKEN)"/>
      </div>

      <div class="row">
        <input id="arquivos" type="file" accept="application/pdf" multiple/>
      </div>

      <div class="row" style="justify-content:flex-end">
        <button class="primary" id="btnEnviar">Enviar PDFs</button>
      </div>

      <div class="status" id="status"></div>

      <div class="divider"></div>
      <div class="muted">
        Dica: ap√≥s enviar os arquivos, a base √© reindexada automaticamente.  
        Voc√™ pode clicar em <b>Ver PDFs</b> para confirmar se os nomes apareceram na pasta do servidor.
      </div>
    </div>

    <!-- Cart√£o de lista -->
    <div class="card hidden" id="cardLista">
      <h1>Arquivos no servidor</h1>
      <p class="sub">Lista lida do diret√≥rio de uploads (persistente no Render).</p>
      <div id="lista"></div>
      <div class="row" style="justify-content:flex-end; margin-top:10px">
        <button class="primary" id="btnVoltar">Voltar</button>
      </div>
    </div>
  </div>

  <script>
    const el = (id) => document.getElementById(id);

    // Alterna cart√µes mantendo seu layout atual
    function showCard(which){
      el('cardUpload').classList.add('hidden');
      el('cardLista').classList.add('hidden');
      el(which).classList.remove('hidden');
    }

    // Navega√ß√£o
    el('btnUpload').onclick = ()=> showCard('cardUpload');
    el('btnListar').onclick = listarPDFs;
    el('btnChat').onclick = ()=> window.location.href = '/chat';
    el('btnVoltar').onclick = ()=> showCard('cardUpload');

    // Upload + reindexa√ß√£o
    el('btnEnviar').onclick = async () => {
      const senha = el('senha').value.trim();
      const arquivos = el('arquivos').files;
      const out = el('status');
      out.innerHTML = '';

      if(!senha){ out.innerHTML = '<p class="err">Informe a senha do admin.</p>'; return; }
      if(!arquivos.length){ out.innerHTML = '<p class="err">Selecione ao menos 1 PDF.</p>'; return; }

      let enviados = 0;
      for (let i=0; i<arquivos.length; i++){
        const fd = new FormData();
        fd.append('file', arquivos[i]);

        try{
          const r = await fetch('/upload_pdf', {
            method:'POST',
            headers:{ 'X-Admin-Token': senha },
            body: fd
          });

          if(r.ok){
            const j = await r.json();
            out.innerHTML += `<div class="ok">‚úÖ ${j.filename} salvo.</div>`;
            enviados++;
          }else{
            const t = await r.text();
            out.innerHTML += `<div class="err">‚ùå ${arquivos[i].name}: ${t}</div>`;
          }
        }catch(e){
          out.innerHTML += `<div class="err">‚ùå ${arquivos[i].name}: ${e.message}</div>`;
        }
      }

      // Reindexar se houve ao menos 1 sucesso
      if(enviados > 0){
        out.innerHTML += `<div class="chip">‚åõ Reindexando base‚Ä¶</div>`;
        try{
          const re = await fetch('/reindex', { method:'POST', headers:{ 'X-Admin-Token': senha } });
          const jr = await re.json();
          if(re.ok && jr.ok){
            out.innerHTML += `<div class="ok">üìö Indexados: ${jr.indexed}</div>`;
            if (jr.files) out.innerHTML += `<div>${jr.files.map(f => `<span class="chip">${f}</span>`).join('')}</div>`;
          }else{
            out.innerHTML += `<div class="err">‚ö†Ô∏è Falha na indexa√ß√£o: ${jr.error || JSON.stringify(jr)}</div>`;
          }
        }catch(e){
          out.innerHTML += `<div class="err">‚ö†Ô∏è Erro ao reindexar: ${e.message}</div>`;
        }
      }
    };

    // Ver PDFs no servidor (sem trocar backend)
    async function listarPDFs(){
      const senha = el('senha').value.trim();
      const box = el('lista');
      box.innerHTML = '';

      if(!senha){
        box.innerHTML = '<p class="err">Digite a senha no cart√£o de Upload e clique novamente em ‚ÄúVer PDFs‚Äù.</p>';
        showCard('cardLista');
        return;
      }

      try{
        const r = await fetch('/admin_diag', { headers:{ 'X-Admin-Token': senha } });
        const j = await r.json();
        if(!r.ok){ box.innerHTML = `<div class="err">${JSON.stringify(j)}</div>`; showCard('cardLista'); return; }

        let html = '';
        if(!j.UPLOAD_DIR_exists){
          html += `<div class="err">Pasta n√£o encontrada: ${j.UPLOAD_DIR}</div>`;
        }else if(!j.UPLOAD_files || j.UPLOAD_files.length === 0){
          html += `<div class="muted">Nenhum PDF enviado ainda.</div>`;
        }else{
          html += `<div class="muted">Diret√≥rio: <code>${j.UPLOAD_DIR}</code></div>`;
          html += `<div style="margin-top:8px">${j.UPLOAD_files.map(f => `<span class="chip">${f}</span>`).join('')}</div>`;
        }
        box.innerHTML = html;
        showCard('cardLista');
      }catch(e){
        box.innerHTML = `<div class="err">${e.message}</div>`;
        showCard('cardLista');
      }
    }
  </script>
</body>
</html>
