<script>
async function enviar(){
  const senha = document.getElementById('senha').value.trim();
  const arquivos = document.getElementById('arquivo').files;
  const status = document.getElementById('status');
  status.innerHTML = '';

  if(!senha){ status.innerHTML='<p class="err">Informe a senha.</p>'; return; }
  if(!arquivos.length){ status.innerHTML='<p class="err">Selecione ao menos 1 PDF.</p>'; return; }

  let houveSucesso = false;

  for(let i=0;i<arquivos.length;i++){
    const fd = new FormData(); fd.append('file', arquivos[i]);
    try{
      const r = await fetch('/upload_pdf', {
        method:'POST',
        headers:{'X-Admin-Token':senha},
        body:fd
      });
      if(r.ok){
        const j = await r.json();
        houveSucesso = true;
        status.innerHTML += '<p class="ok">‚úÖ '+ j.filename +' salvo.</p>';
      }else{
        const e = await r.text();
        status.innerHTML += '<p class="err">‚ùå '+arquivos[i].name+': '+e+'</p>';
      }
    }catch(err){
      status.innerHTML += '<p class="err">‚ùå '+arquivos[i].name+': '+err.message+'</p>';
    }
  }

  // se salvou pelo menos um, dispara reindexa√ß√£o (r√°pida)
  if(houveSucesso){
    status.innerHTML += '<p>üîÑ Indexando base‚Ä¶</p>';
    try{
      const r2 = await fetch('/reindex', {method:'POST', headers:{'X-Admin-Token':senha}});
      const j2 = await r2.json();
      if(r2.ok && j2.ok){
        status.innerHTML += '<p class="ok">‚úÖ Indexados: '+ j2.indexed +'</p>';
      }else{
        status.innerHTML += '<p class="err">‚ö†Ô∏è Falha ao indexar: '+ JSON.stringify(j2) +'</p>';
      }
    }catch(e){
      status.innerHTML += '<p class="err">‚ö†Ô∏è Erro na indexa√ß√£o: '+ e.message +'</p>';
    }
  }
}
</script>
