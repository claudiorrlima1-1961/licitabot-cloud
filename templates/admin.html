<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin ‚Äî LICITABOT</title>
  <style>
    :root{--ink:#0f172a;--muted:#475569;--bg:#f5f7fa;--card:#fff;--cta:#0b3d5c;--ok:#166534;--err:#991b1b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink)}
    .wrap{max-width:920px;margin:28px auto;padding:16px}
    .tabs{display:flex;gap:16px;margin-bottom:16px}
    .tab{background:#e2e8f0;padding:14px 18px;border-radius:16px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:10px}
    .tab:hover{filter:brightness(1.03)}
    .card{background:var(--card);border-radius:18px;box-shadow:0 10px 28px rgba(0,0,0,.12);padding:22px}
    h1{margin:4px 0 12px}
    .muted{color:var(--muted)}
    input[type=password],input[type=file]{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:12px;margin:8px 0 12px}
    button{background:var(--cta);color:#fff;border:none;border-radius:12px;padding:12px 18px;font-weight:700;cursor:pointer}
    button:hover{filter:brightness(1.06)}
    .msg{margin-top:10px;font-size:14px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    ul{list-style:none;padding:0;margin:10px 0}
    li{display:flex;justify-content:space-between;align-items:center;border:1px solid #e2e8f0;border-radius:12px;padding:10px 12px;margin:8px 0;background:#fbfdff}
    .tiny{font-size:12px;color:var(--muted);margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="tabs">
      <div class="tab" onclick="show('upload')">üì¶ Upload</div>
      <div class="tab" onclick="show('lista')">üìÅ Ver PDFs</div>
      <div class="tab" onclick="window.location='/'">üí¨ Chat</div>
    </div>

    <div id="upload" class="card">
      <h1>Envio de PDFs (Admin)</h1>
      <p class="muted">Digite a senha do administrador e selecione um ou mais PDFs.</p>
      <input id="adm" type="password" placeholder="Senha do admin (ADMIN_UPLOAD_TOKEN)"/>
      <input id="files" type="file" accept="application/pdf" multiple/>
      <button onclick="enviar()">Enviar PDFs</button>
      <div id="status" class="msg"></div>
      <p class="tiny">Dica: ap√≥s enviar os arquivos, a base √© reindexada automaticamente.</p>
    </div>

    <div id="lista" class="card" style="display:none">
      <h1>Arquivos no servidor</h1>
      <p class="muted">Listagem dos PDFs j√° enviados. Voc√™ pode excluir se necess√°rio.</p>
      <div class="row" style="display:flex;gap:10px">
        <input id="adm2" type="password" placeholder="Senha do admin (ADMIN_UPLOAD_TOKEN)" style="flex:1"/>
        <button onclick="carregar()">Atualizar lista</button>
      </div>
      <ul id="ul"></ul>
      <div id="listMsg" class="msg"></div>
    </div>
  </div>

  <script>
    function show(id){
      document.getElementById('upload').style.display = (id==='upload'?'block':'none');
      document.getElementById('lista').style.display  = (id==='lista'?'block':'none');
      if(id==='lista'){ carregar(); }
    }

    async function enviar(){
      const senha = (document.getElementById('adm').value || '').trim();
      const arquivos = document.getElementById('files').files;
      const status = document.getElementById('status');
      status.innerHTML = '';
      if(!senha){ status.innerHTML='<span class="err">Informe a senha.</span>'; return; }
      if(!arquivos.length){ status.innerHTML='<span class="err">Selecione ao menos 1 PDF.</span>'; return; }

      for(let i=0;i<arquivos.length;i++){
        const fd = new FormData(); fd.append('file', arquivos[i]);
        try{
          const r = await fetch('/upload_pdf', {method:'POST', headers:{'X-Admin-Token':senha}, body:fd});
          if(r.ok){
            const j = await r.json();
            status.innerHTML += '<div class="ok">‚úÖ '+ j.filename +' ‚Äî ' + (j.indexed?'indexado':'salvo (sem index)') + '</div>';
          }else{
            const e = await r.text();
            status.innerHTML += '<div class="err">‚ùå '+arquivos[i].name+': '+e+'</div>';
          }
        }catch(err){
          status.innerHTML += '<div class="err">‚ùå '+arquivos[i].name+': '+err.message+'</div>';
        }
      }
    }

    async function carregar(){
      const senha = (document.getElementById('adm2').value || '').trim();
      const ul = document.getElementById('ul');
      const msg = document.getElementById('listMsg');
      ul.innerHTML = ''; msg.textContent = '';
      if(!senha){ msg.innerHTML='<span class="err">Informe a senha.</span>'; return; }
      try{
        const r = await fetch('/list_pdfs', {headers:{'X-Admin-Token':senha}});
        if(!r.ok){ msg.innerHTML='<span class="err">'+await r.text()+'</span>'; return; }
        const j = await r.json();
        if(!j.files || !j.files.length){ ul.innerHTML='<li>Nenhum PDF encontrado.</li>'; return; }
        j.files.forEach(name=>{
          const li = document.createElement('li');
          li.innerHTML = '<span>'+name+'</span><button data-n="'+name+'">Excluir</button>';
          li.querySelector('button').onclick = ()=>excluir(name, senha);
          ul.appendChild(li);
        });
      }catch(e){
        msg.innerHTML='<span class="err">'+e.message+'</span>';
      }
    }

    async function excluir(name, senha){
      if(!confirm('Excluir "'+name+'"?')) return;
      const ul = document.getElementById('ul');
      const msg = document.getElementById('listMsg');
      try{
        const r = await fetch('/delete_pdf?name='+encodeURIComponent(name), {
          method:'DELETE', headers:{'X-Admin-Token':senha}
        });
        if(!r.ok){ msg.innerHTML='<span class="err">'+await r.text()+'</span>'; return; }
        msg.innerHTML='<span class="ok">Arquivo exclu√≠do.</span>';
        carregar();
      }catch(e){
        msg.innerHTML='<span class="err">'+e.message+'</span>';
      }
    }
  </script>
</body>
</html>
